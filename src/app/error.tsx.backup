'use client';

import { useEffect, useState, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { HeartIcon, HomeIcon, ArrowPathIcon, QuestionMarkCircleIcon, WifiIcon, ServerIcon, ShieldCheckIcon, ExclamationTriangleIcon } from '@heroicons/react/24/outline';
import { CheckCircleIcon } from '@heroicons/react/24/solid';
import Link from 'next/link';
import Header from '@/components/layout/Header';
import { useLanguage } from '@/components/language/LanguageContext';
import { useNetworkStatus } from '@/hooks/useNetworkStatus';

// Error categorization with intelligent detection
const categorizeError = (error: Error) => {
  const message = error.message.toLowerCase();
  const stack = error.stack?.toLowerCase() || '';

  // Network and connectivity errors
  if (message.includes('fetch') || message.includes('network') || message.includes('connection') ||
      message.includes('timeout') || message.includes('cors') || message.includes('aborted')) {
    return 'network';
  }

  // Database and data errors
  if (message.includes('database') || message.includes('prisma') || message.includes('sql') ||
      message.includes('connection') && message.includes('database') || message.includes('query')) {
    return 'database';
  }

  // Authentication and authorization errors
  if (message.includes('auth') || message.includes('unauthorized') || message.includes('forbidden') ||
      message.includes('permission') || message.includes('access denied') || message.includes('jwt')) {
    return 'auth';
  }

  // Validation errors
  if (message.includes('validation') || message.includes('invalid') || message.includes('required') ||
      message.includes('format') || stack.includes('zod') || stack.includes('validation')) {
    return 'validation';
  }

  // Client-side errors
  if (message.includes('referenceerror') || message.includes('typeerror') || message.includes('syntaxerror') ||
      message.includes('cannot read') || message.includes('undefined')) {
    return 'client';
  }

  // Server errors
  if (message.includes('500') || message.includes('502') || message.includes('503') ||
      message.includes('504') || message.includes('internal server')) {
    return 'server';
  }

  return 'generic';
};

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  const { t } = useLanguage();
  const { isOnline, isSlowConnection } = useNetworkStatus();

  // Enhanced state management
  const [retryCount, setRetryCount] = useState(0);
  const [isRetrying, setIsRetrying] = useState(false);
  const [errorId] = useState(() => `error_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`);

  // Intelligent error categorization
  const errorType = categorizeError(error);

  // Error recovery strategies based on type
  const getRecoveryStrategies = useCallback(() => {
    const strategies = [];

    switch (errorType) {
      case 'network':
        strategies.push(
          { action: 'check_connection', label: t('error.network_action', 'Check your internet connection'), priority: 1 },
          { action: 'retry', label: t('common.retry', 'Try again'), priority: 2 },
          { action: 'reload', label: t('error.reload_page', 'Reload page'), priority: 3 }
        );
        break;
      case 'auth':
        strategies.push(
          { action: 'login', label: t('error.unauthorized.login', 'Sign in again'), priority: 1 },
          { action: 'home', label: t('common.back', 'Go back home'), priority: 2 }
        );
        break;
      case 'validation':
        strategies.push(
          { action: 'reload', label: t('error.reload_page', 'Reload page'), priority: 1 },
          { action: 'contact', label: t('error.contact_support', 'Contact support'), priority: 2 }
        );
        break;
      default:
        strategies.push(
          { action: 'retry', label: t('common.retry', 'Try again'), priority: 1 },
          { action: 'home', label: t('common.back', 'Go back home'), priority: 2 },
          { action: 'reload', label: t('error.reload_page', 'Reload page'), priority: 3 }
        );
    }

    return strategies.sort((a, b) => a.priority - b.priority);
  }, [errorType, t]);

  // Enhanced error logging with analytics
  useEffect(() => {
    const logError = async () => {
      try {
        // Enhanced error logging
        console.error(' Application Error:', {
          id: errorId,
          type: errorType,
          message: error.message,
          stack: error.stack?.slice(0, 500),
          digest: error.digest,
          userAgent: navigator.userAgent,
          url: window.location.href,
          timestamp: new Date().toISOString(),
          networkStatus: { isOnline, isSlowConnection },
          retryCount,
        });

        // Send to error tracking service
        if (typeof window !== 'undefined' && window.gtag) {
          window.gtag('event', 'exception', {
            description: `${errorType}: ${error.message}`,
            fatal: errorType === 'server' || errorType === 'database',
            custom_map: {
              error_id: errorId,
              error_type: errorType,
              retry_count: retryCount,
              user_online: isOnline,
            },
          });
        }

        // Enhanced error tracking
        import('@/lib/error-tracking').then(({ errorTracker }) => {
          errorTracker.trackError(`app_error_${errorType}`, error, {
            errorId,
            errorType,
            userAgent: navigator.userAgent,
            url: window.location.href,
            networkStatus: { isOnline, isSlowConnection },
            retryCount,
            timestamp: new Date().toISOString(),
          });
        });
      } catch (loggingError) {
        console.error('Error logging failed:', loggingError);
      }
    };

    logError();
  }, [error, errorId, errorType, isOnline, isSlowConnection, retryCount]);

  // Smart retry mechanism
  const handleRetry = useCallback(async () => {
    setIsRetrying(true);
    setRetryCount(prev => prev + 1);

    // Track retry attempt
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('event', 'retry_attempt', {
        custom_map: {
          error_type: errorType,
          retry_count: retryCount + 1,
          error_id: errorId,
        },
      });
    }

    try {
      // Add small delay for better UX
      await new Promise(resolve => setTimeout(resolve, 500));
      reset();
    } catch (retryError) {
      console.error('Retry failed:', retryError);
      setIsRetrying(false);
    }
  }, [reset, errorType, retryCount, errorId]);

  // Intelligent error icon selection
  const getErrorIcon = () => {
    switch (errorType) {
      case 'network':
        return <WifiIcon className="w-10 h-10 text-blue-600 dark:text-blue-400" />;
      case 'auth':
        return <ShieldCheckIcon className="w-10 h-10 text-purple-600 dark:text-purple-400" />;
      case 'database':
        return <ServerIcon className="w-10 h-10 text-orange-600 dark:text-orange-400" />;
      case 'validation':
        return <ExclamationTriangleIcon className="w-10 h-10 text-yellow-600 dark:text-yellow-400" />;
      default:
        return <QuestionMarkCircleIcon className="w-10 h-10 text-blue-600 dark:text-blue-400" />;
    }
  };

  // Error-specific styling
  const getErrorTheme = () => {
    switch (errorType) {
      case 'network':
        return {
          gradient: 'from-blue-500 to-cyan-500',
          bgGradient: 'from-blue-50 to-cyan-50',
          borderColor: 'border-blue-200 dark:border-blue-700',
          textColor: 'text-blue-800 dark:text-blue-200',
        };
      case 'auth':
        return {
          gradient: 'from-purple-500 to-pink-500',
          bgGradient: 'from-purple-50 to-pink-50',
          borderColor: 'border-purple-200 dark:border-purple-700',
          textColor: 'text-purple-800 dark:text-purple-200',
        };
      case 'database':
        return {
          gradient: 'from-orange-500 to-red-500',
          bgGradient: 'from-orange-50 to-red-50',
          borderColor: 'border-orange-200 dark:border-orange-700',
          textColor: 'text-orange-800 dark:text-orange-200',
        };
      case 'validation':
        return {
          gradient: 'from-yellow-500 to-orange-500',
          bgGradient: 'from-yellow-50 to-orange-50',
          borderColor: 'border-yellow-200 dark:border-yellow-700',
          textColor: 'text-yellow-800 dark:text-yellow-200',
        };
      default:
        return {
          gradient: 'from-blue-500 to-purple-500',
          bgGradient: 'from-blue-50 to-purple-50',
          borderColor: 'border-blue-200 dark:border-blue-700',
          textColor: 'text-blue-800 dark:text-blue-200',
        };
    }
  };

  const theme = getErrorTheme();
  const strategies = getRecoveryStrategies();

  // Legacy error detection (for backward compatibility with some existing logic)
  const isNetworkError = error.message.includes('fetch') || error.message.includes('network');
  const isDatabaseError = error.message.includes('database') || error.message.includes('prisma');
  const isAuthError = error.message.includes('auth') || error.message.includes('unauthorized');

  // Enhanced error messaging with intelligent categorization
  const getErrorTitle = () => {
    switch (errorType) {
      case 'network':
        return isSlowConnection
          ? t('error.network_slow', 'Conexi贸n lenta detectada')
          : t('error.network_title', 'Sin conexi贸n a internet');
      case 'database':
        return t('error.database_title', 'Problema con la informaci贸n');
      case 'auth':
        return t('error.auth_title', 'Acceso restringido');
      case 'validation':
        return t('error.validation_error', 'Datos de entrada inv谩lidos');
      case 'client':
        return t('error.client_error', 'Error del navegador');
      case 'server':
        return t('error.server_unavailable', 'Servidor no disponible');
      default:
        return t('error.general_title', '隆Uy! Algo sali贸 mal');
    }
  };

  const getErrorMessage = () => {
    switch (errorType) {
      case 'network':
        return isSlowConnection
          ? t('error.slow_connection_message', 'La conexi贸n es lenta. El rendimiento puede verse afectado.')
          : t('error.network_error', 'Error de conexi贸n. Verifica tu conexi贸n a internet.');
      case 'database':
        return t('error.search_problem', 'Tuvimos un problema al buscar la informaci贸n. Ya estamos trabajando para solucionarlo.');
      case 'auth':
        return t('error.session_expired', 'Tu sesi贸n termin贸 o no tienes permiso para entrar aqu铆. Vuelve a iniciar sesi贸n si es necesario.');
      case 'validation':
        return t('error.general', 'Los datos proporcionados no son v谩lidos. Por favor, verifica e intenta nuevamente.');
      case 'client':
        return t('error.general', 'Ha ocurrido un error en la aplicaci贸n. Estamos trabajando para solucionarlo.');
      case 'server':
        return t('error.general', 'El servidor est谩 experimentando dificultades. Por favor, intenta m谩s tarde.');
      default:
        return t('error.general', 'Algo no funcion贸 como esper谩bamos. Intenta nuevamente o cu茅ntanos si el problema sigue.');
    }
  };

  const getRecommendedAction = () => {
    switch (errorType) {
      case 'network':
        return isSlowConnection
          ? t('error.retry_later', 'Espera un momento e intenta nuevamente')
          : t('error.network_action', 'Revisa tu internet y actualiza la p谩gina');
      case 'database':
        return t('error.database_action', 'Intenta de nuevo en unos minutos');
      case 'auth':
        return t('error.auth_action', 'Vuelve a iniciar sesi贸n');
      case 'validation':
        return t('error.general_action', 'Actualiza la p谩gina o vuelve al inicio');
      case 'client':
        return t('error.reload_page', 'Recarga la p谩gina');
      case 'server':
        return t('error.retry_later', 'Intenta de nuevo en unos minutos');
      default:
        return t('error.general_action', 'Actualiza la p谩gina o vuelve al inicio');
    }
  };

  return (
    <div className="h-screen bg-background overflow-hidden md:overflow-hidden">
      <Header />
      <div className="flex items-center justify-center p-4 h-screen overflow-y-auto md:overflow-hidden bg-[url('/bg2.jpg')] bg-cover bg-center">
        <div className="w-full max-w-md relative px-4 sm:px-6 flex flex-col items-center -top-5">
          {/* SEO and accessibility meta information */}
          <head>
            <title>{getErrorTitle()} - Manitos Pintadas</title>
            <meta name="description" content={getErrorMessage()} />
            <meta name="robots" content="noindex, nofollow" />
            <meta name="error-id" content={errorId} />
            <meta name="error-type" content={errorType} />
            <meta property="og:title" content={getErrorTitle()} />
            <meta property="og:description" content={getErrorMessage()} />
            <meta property="og:type" content="website" />
          </head>

          <div className="backdrop-blur-xl bg-white/95 dark:bg-gray-900/95 border border-gray-200/50 dark:border-gray-700/50 rounded-xl shadow-2xl p-6 w-full max-w-md mx-auto flex flex-col items-center justify-center space-y-4">

            {/* Error Icon */}
            <div className={`w-16 h-16 bg-gradient-to-br ${theme.bgGradient} dark:from-gray-700/50 dark:to-gray-800/50 rounded-full flex items-center justify-center shadow-lg ring-4 ring-white/50 dark:ring-gray-700/50`}>
              {getErrorIcon()}
            </div>

            {/* Error Title */}
            <h2 className={`text-xl font-bold bg-gradient-to-r ${theme.gradient} bg-clip-text text-transparent text-center`}>
              {getErrorTitle()}
            </h2>

            {/* Error ID */}
            <div className="text-xs text-gray-500 dark:text-gray-400 font-mono">
              Error ID: {errorId}
            </div>

            {/* Error Message */}
            <p className="text-gray-700 dark:text-gray-300 text-center leading-relaxed">
              {getErrorMessage()}
            </p>

            {/* Recommendation */}
            <div className={`bg-gradient-to-r ${theme.bgGradient} dark:from-gray-700/30 dark:to-gray-800/30 rounded-lg p-3 border ${theme.borderColor} w-full`}>
              <div className="flex items-center justify-center mb-2">
                <div className={`w-6 h-6 bg-gradient-to-r ${theme.gradient} rounded-full flex items-center justify-center mr-2 shadow-sm`}>
                  <CheckCircleIcon className="w-3 h-3 text-white" />
                </div>
                <span className={`text-sm font-semibold ${theme.textColor}`}>
                  {t('error.recommendation', 'Recomendaci贸n')}
                </span>
              </div>
              <p className={`text-sm ${theme.textColor} font-medium text-center leading-relaxed`}>
                {getRecommendedAction()}
              </p>
            </div>


            {/* Action Buttons */}
            <div className="space-y-2 w-full">
              {strategies.slice(0, 2).map((strategy, index) => (
                <Button
                  key={strategy.action}
                  onClick={strategy.action === 'retry' ? handleRetry :
                          strategy.action === 'reload' ? () => window.location.reload() :
                          undefined}
                  asChild={strategy.action === 'login' || strategy.action === 'home'}
                  disabled={strategy.action === 'retry' && isRetrying}
                  className={`w-full bg-gradient-to-r ${theme.gradient} hover:opacity-90 text-white font-medium py-3 text-sm shadow-lg hover:shadow-xl transition-all duration-300 ${
                    index === 0 ? 'ring-2 ring-white/50' : ''
                  }`}
                >
                  {strategy.action === 'login' ? (
                    <Link href="/login" className="flex items-center justify-center">
                      <ShieldCheckIcon className="w-4 h-4 mr-2" />
                      {strategy.label}
                    </Link>
                  ) : strategy.action === 'home' ? (
                    <Link href="/" className="flex items-center justify-center">
                      <HomeIcon className="w-4 h-4 mr-2" />
                      {strategy.label}
                    </Link>
                  ) : strategy.action === 'contact' ? (
                    <a href="mailto:ayuda@manitospintadas.cl" className="flex items-center justify-center">
                      <HeartIcon className="w-4 h-4 mr-2" />
                      {strategy.label}
                    </a>
                  ) : strategy.action === 'check_connection' ? (
                    <div className="flex items-center justify-center cursor-pointer" onClick={() => window.location.reload()}>
                      <WifiIcon className="w-4 h-4 mr-2" />
                      {strategy.label}
                    </div>
                  ) : (
                    <div className="flex items-center justify-center">
                      {strategy.action === 'retry' && <ArrowPathIcon className={`w-4 h-4 mr-2 ${isRetrying ? 'animate-spin' : ''}`} />}
                      {strategy.action === 'reload' && <ArrowPathIcon className="w-4 h-4 mr-2" />}
                      {strategy.label}
                    </div>
                  )}
                </Button>
              ))}
            </div>

            {/* Help Section - Compact */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-4 border border-blue-100 dark:border-blue-800/30 w-full">
              <div className="flex items-center justify-center mb-2">
                <HeartIcon className="w-4 h-4 text-blue-500 mr-2" />
                <span className="text-sm font-semibold text-blue-800 dark:text-blue-200">
                  {t('error.need_help', '驴Necesitas ayuda?')}
                </span>
              </div>

              <div className="flex gap-2 justify-center">
                <a
                  href="mailto:ayuda@manitospintadas.cl"
                  className={`inline-flex items-center px-3 py-1 bg-gradient-to-r ${theme.gradient} text-white font-medium rounded text-xs shadow-md hover:shadow-lg transition-all duration-200`}
                >
                  <HeartIcon className="w-3 h-3 mr-1" />
                  {t('error.contact_support', 'Soporte')}
                </a>

                <a
                  href="tel:+56912345678"
                  className={`inline-flex items-center px-3 py-1 border ${theme.borderColor} ${theme.textColor} font-medium rounded text-xs hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all duration-200`}
                >
                   {t('error.call_now', 'Llamar')}
                </a>
              </div>
            </div>

            {/* Technical Details - Collapsible */}
            {process.env.NODE_ENV === 'development' && (
              <details className="w-full text-left">
                <summary className="text-xs text-gray-600 dark:text-gray-400 cursor-pointer hover:text-gray-800 dark:hover:text-gray-200 font-medium flex items-center justify-center py-2">
                  <QuestionMarkCircleIcon className="w-4 h-4 mr-2" />
                  {t('error.dev_info', 'Detalles T茅cnicos')}
                </summary>

                <div className="space-y-2 mt-2">
                  <div className="bg-gray-50 dark:bg-gray-800/50 rounded p-2 text-xs">
                    <div className="font-semibold text-gray-500 dark:text-gray-400 mb-1">Error ID</div>
                    <div className="font-mono text-gray-800 dark:text-gray-200 break-all text-xs">{errorId}</div>
                  </div>

                  <div className="bg-gray-50 dark:bg-gray-800/50 rounded p-2 text-xs">
                    <div className="font-semibold text-gray-500 dark:text-gray-400 mb-1">Mensaje</div>
                    <div className="font-mono text-red-600 dark:text-red-400 break-words text-xs">{error.message}</div>
                  </div>

                  {error.stack && (
                    <div className="bg-gray-50 dark:bg-gray-800/50 rounded p-2 text-xs">
                      <div className="font-semibold text-gray-500 dark:text-gray-400 mb-1">Stack Trace</div>
                      <pre className="font-mono text-gray-700 dark:text-gray-300 overflow-auto max-h-20 bg-white dark:bg-gray-900 p-1 rounded text-xs">
                        {error.stack.slice(0, 400)}...
                      </pre>
                    </div>
                  )}

                  <div className="bg-gray-50 dark:bg-gray-800/50 rounded p-2 text-xs">
                    <div className="font-semibold text-gray-500 dark:text-gray-400 mb-1">Estado</div>
                    <div className="flex justify-between">
                      <span className={isOnline ? 'text-green-600' : 'text-red-600'}>
                        {isOnline ? ' Online' : ' Offline'}
                      </span>
                      <span className="text-gray-600">Retry: {retryCount}</span>
                    </div>
                  </div>
                </div>
              </details>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
