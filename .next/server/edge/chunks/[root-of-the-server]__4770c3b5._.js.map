{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/lib/middleware-auth.ts"],"sourcesContent":["// Middleware-compatible authentication helper\n// This runs in Edge Runtime and doesn't use Prisma\n\nimport { NextRequest } from 'next/server';\nimport { jwtVerify } from 'jose';\n\nconst JWT_SECRET = new TextEncoder().encode(\n  process.env.NEXTAUTH_SECRET || 'fallback-secret-change-in-production'\n);\n\nexport interface MiddlewareUser {\n  id: string;\n  email: string;\n  name?: string | null;\n  role: 'MASTER' | 'ADMIN' | 'PROFESOR' | 'PARENT' | 'PUBLIC';\n  needsRegistration?: boolean;\n  isOAuthUser?: boolean;\n}\n\nexport interface MiddlewareSession {\n  user: MiddlewareUser;\n  expires: string;\n}\n\n/**\n * Extract and validate JWT token from request cookies\n * Compatible with NextAuth JWT structure\n */\nexport async function getMiddlewareAuth(request: NextRequest): Promise<MiddlewareSession | null> {\n  try {\n    // Get the session token from cookies (NextAuth uses 'next-auth.session-token')\n    const token = request.cookies.get('next-auth.session-token')?.value ||\n                  request.cookies.get('__Secure-next-auth.session-token')?.value;\n\n    if (!token) {\n      return null;\n    }\n\n    // Verify and decode the JWT\n    const { payload } = await jwtVerify(token, JWT_SECRET);\n\n    // Extract user data from JWT payload\n    const user: MiddlewareUser = {\n      id: payload.id as string,\n      email: payload.email as string,\n      name: payload.name as string | null,\n      role: payload.role as 'MASTER' | 'ADMIN' | 'PROFESOR' | 'PARENT' | 'PUBLIC',\n      needsRegistration: payload.needsRegistration as boolean,\n      isOAuthUser: payload.isOAuthUser as boolean,\n    };\n\n    return {\n      user,\n      expires: payload.exp ? new Date(payload.exp * 1000).toISOString() : new Date().toISOString(),\n    };\n  } catch (error) {\n    // Token is invalid or expired\n    console.warn('Middleware auth error:', error);\n    return null;\n  }\n}\n\n/**\n * Check if user has required role for route access\n */\nexport function hasMiddlewareAccess(\n  userRole: string | undefined,\n  requiredRoles: string[]\n): boolean {\n  if (!userRole) return false;\n  return requiredRoles.includes(userRole);\n}\n\n/**\n * Get redirect path based on user role\n */\nexport function getRoleRedirectPath(userRole: string | undefined): string {\n  switch (userRole) {\n    case 'MASTER':\n      return '/master';\n    case 'ADMIN':\n      return '/admin';\n    case 'PROFESOR':\n      return '/profesor';\n    case 'PARENT':\n      return '/parent';\n    default:\n      return '/';\n  }\n}"],"names":[],"mappings":"AAAA,8CAA8C;AAC9C,mDAAmD;;;;;;;;;AAGnD;;AAEA,MAAM,aAAa,IAAI,cAAc,MAAM,CACzC,QAAQ,GAAG,CAAC,eAAe,IAAI;AAqB1B,eAAe,kBAAkB,OAAoB;IAC1D,IAAI;QACF,+EAA+E;QAC/E,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,4BAA4B,SAChD,QAAQ,OAAO,CAAC,GAAG,CAAC,qCAAqC;QAEvE,IAAI,CAAC,OAAO;YACV,OAAO;QACT;QAEA,4BAA4B;QAC5B,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,4KAAS,EAAC,OAAO;QAE3C,qCAAqC;QACrC,MAAM,OAAuB;YAC3B,IAAI,QAAQ,EAAE;YACd,OAAO,QAAQ,KAAK;YACpB,MAAM,QAAQ,IAAI;YAClB,MAAM,QAAQ,IAAI;YAClB,mBAAmB,QAAQ,iBAAiB;YAC5C,aAAa,QAAQ,WAAW;QAClC;QAEA,OAAO;YACL;YACA,SAAS,QAAQ,GAAG,GAAG,IAAI,KAAK,QAAQ,GAAG,GAAG,MAAM,WAAW,KAAK,IAAI,OAAO,WAAW;QAC5F;IACF,EAAE,OAAO,OAAO;QACd,8BAA8B;QAC9B,QAAQ,IAAI,CAAC,0BAA0B;QACvC,OAAO;IACT;AACF;AAKO,SAAS,oBACd,QAA4B,EAC5B,aAAuB;IAEvB,IAAI,CAAC,UAAU,OAAO;IACtB,OAAO,cAAc,QAAQ,CAAC;AAChC;AAKO,SAAS,oBAAoB,QAA4B;IAC9D,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF"}},
    {"offset": {"line": 79, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { getMiddlewareAuth, hasMiddlewareAccess, getRoleRedirectPath } from '@/lib/middleware-auth';\nimport { NextRequest, NextResponse } from 'next/server';\n\n// Role hierarchy for authorization (future use in role comparison)\nconst _ROLE_HIERARCHY = {\n  MASTER: 4,\n  ADMIN: 3,\n  PROFESOR: 2,\n  PARENT: 1,\n  PUBLIC: 0,\n} as const;\n\ntype UserRole = keyof typeof _ROLE_HIERARCHY;\n\n// Route access control matrix\nconst ROUTE_ACCESS: Record<string, UserRole[]> = {\n  '/master': ['MASTER'],\n  '/admin': ['MASTER', 'ADMIN'],\n  '/profesor': ['MASTER', 'ADMIN', 'PROFESOR'],\n  '/parent': ['MASTER', 'ADMIN', 'PARENT'],\n  '/api/master': ['MASTER'],\n  '/api/admin': ['MASTER', 'ADMIN'],\n  '/api/profesor': ['MASTER', 'ADMIN', 'PROFESOR'],\n  '/api/parent': ['MASTER', 'ADMIN', 'PARENT'],\n};\n\n// Security headers for all responses\nconst SECURITY_HEADERS = {\n  'X-Frame-Options': 'DENY',\n  'X-Content-Type-Options': 'nosniff',\n  'X-XSS-Protection': '1; mode=block',\n  'Referrer-Policy': 'strict-origin-when-cross-origin',\n} as const;\n\nfunction addSecurityHeaders(response: NextResponse): NextResponse {\n  Object.entries(SECURITY_HEADERS).forEach(([key, value]) => {\n    response.headers.set(key, value);\n  });\n  return response;\n}\n\n// Authorization helper moved to middleware-auth.ts\n\n// Edge Runtime compatible middleware\nexport default async function middleware(req: NextRequest) {\n  try {\n    const { nextUrl } = req;\n    const pathname = nextUrl.pathname;\n\n    // Skip middleware for static assets and system paths\n    if (\n      pathname.includes('_next/static') ||\n      pathname.includes('_next/image') ||\n      pathname.includes('favicon') ||\n      pathname.match(/\\.(svg|png|jpg|jpeg|gif|webp|ico|css|js)$/)\n    ) {\n      return NextResponse.next();\n    }\n\n    // Get session and user info using middleware-compatible auth\n    const session = await getMiddlewareAuth(req);\n    const isLoggedIn = Boolean(session?.user);\n    const userRole = session?.user?.role as UserRole | undefined;\n\n    // Log security events in development\n    if (process.env.NODE_ENV === 'development') {\n      console.log(`ðŸ” Route: ${pathname} | User: ${userRole || 'ANONYMOUS'} | Logged: ${isLoggedIn}`);\n    }\n\n    // Handle auth pages\n    const isAuthPage = pathname.startsWith('/login') || pathname.startsWith('/registro');\n    \n    if (isAuthPage && isLoggedIn && userRole) {\n      const redirectPath = getRoleRedirectPath(userRole);\n      const response = NextResponse.redirect(new URL(redirectPath, nextUrl));\n      return addSecurityHeaders(response);\n    }\n\n    // Check if route requires authentication\n    const requiresAuth = Object.keys(ROUTE_ACCESS).some(route => pathname.startsWith(route));\n    \n    if (requiresAuth && !isLoggedIn) {\n      const loginUrl = new URL('/login', nextUrl);\n      loginUrl.searchParams.set('callbackUrl', nextUrl.toString());\n      const response = NextResponse.redirect(loginUrl);\n      return addSecurityHeaders(response);\n    }\n\n    // Check authorization for protected routes\n    if (requiresAuth) {\n      // Find matching route pattern for authorization\n      const matchingRoute = Object.keys(ROUTE_ACCESS).find(route =>\n        pathname.startsWith(route)\n      );\n\n      if (matchingRoute && !hasMiddlewareAccess(userRole, ROUTE_ACCESS[matchingRoute])) {\n        // Log unauthorized access attempt\n        console.warn(`ðŸš¨ Unauthorized access attempt: ${userRole} â†’ ${pathname}`);\n\n        // Redirect to appropriate dashboard or show unauthorized\n        const allowedPath = isLoggedIn && userRole\n          ? getRoleRedirectPath(userRole)\n          : '/unauthorized';\n\n        const response = NextResponse.redirect(new URL(allowedPath, nextUrl));\n        return addSecurityHeaders(response);\n      }\n    }\n\n    // Add security headers to all responses\n    const response = NextResponse.next();\n    return addSecurityHeaders(response);\n\n  } catch (error) {\n    console.error('ðŸš¨ Middleware error:', error);\n    \n    // Fail secure - redirect to login on error\n    const response = NextResponse.redirect(new URL('/login', req.nextUrl));\n    return addSecurityHeaders(response);\n  }\n}\n\nexport const config = {\n  matcher: [\n    // Match all request paths except static files and system paths\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp|ico|css|js)$).*)',\n  ],\n};"],"names":[],"mappings":"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"}}]
}