// =======================================================
//  NORMALIZED DATABASE SCHEMA - REPLACES JSON COLUMNS
// =======================================================
// This schema eliminates JSON column antipatterns and 
// implements proper relational design

generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== EXISTING MODELS (UNCHANGED) =====

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model User {
  id                String                  @id @default(cuid())
  name              String?
  email             String                  @unique
  emailVerified     DateTime?               @map("email_verified")
  image             String?
  password          String?
  phone             String?
  role              UserRole                @default(PROFESOR)
  isActive          Boolean                 @default(true) @map("is_active")
  parentRole        String?                 @map("parent_role")
  status            UserStatus?             @default(ACTIVE)
  provider          String?
  isOAuthUser       Boolean                 @default(false) @map("is_oauth_user")
  createdByAdmin    String?                 @map("created_by_admin")
  createdAt         DateTime                @default(now()) @map("created_at")
  updatedAt         DateTime                @updatedAt @map("updated_at")
  
  // Relations
  accounts          Account[]
  eventTemplates    CalendarEventTemplate[]
  authoredEvents    CalendarEvent[]         @relation("CalendarEventAuthor")
  meetings          Meeting[]
  uploadedPhotos    Photo[]                 @relation("PhotoUploader")
  planningDocuments PlanningDocument[]
  sessions          Session[]
  uploadedVideos    Video[]                 @relation("VideoUploader")
  votes             VoteResponse[]          @relation("UserVotes")
  attendingEvents   CalendarEvent[]         @relation("CalendarEventAttendees")
  createdVotes      Vote[]                  @relation("VoteCreator")
  activities        Activity[]
  taughtStudents    Student[]               @relation("StudentTeacher")
  parentStudents    Student[]               @relation("StudentParent")
  progressReports   StudentProgressReport[] @relation("ProgressReportTeacher")
  sentNotifications Notification[]          @relation("NotificationSender")
  receivedNotifications Notification[]      @relation("NotificationRecipient")

  @@map("users")
}

// ===== NORMALIZED SCHOOL CONFIGURATION =====
// BEFORE: SchoolInfo with JSON columns
// AFTER: Proper relational tables

model SchoolInfo {
  id                String                      @id @default(cuid())
  name              String
  mission           String
  vision            String
  address           String
  phone             String
  email             String
  website           String
  logoUrl           String?                     @map("logo_url")
  institutionType   EducationalInstitutionType  @default(PRESCHOOL) @map("institution_type")
  createdAt         DateTime                    @default(now()) @map("created_at")
  updatedAt         DateTime                    @default(now()) @updatedAt @map("updated_at")

  // Normalized relations (replaces JSON columns)
  supportedLevels   SchoolEducationalLevel[]
  customGrades      SchoolGrade[]
  customSubjects    SchoolSubject[]
  educationalConfig SchoolConfiguration[]

  @@map("school_info")
}

// NEW: Educational levels (was JSON in supportedLevels)
model SchoolEducationalLevel {
  id           String     @id @default(cuid())
  schoolId     String     @map("school_id")
  iscedLevel   ISCEDLevel @map("isced_level")
  levelName    String     @map("level_name") // e.g., "Educaci贸n Parvularia"
  description  String?
  isActive     Boolean    @default(true) @map("is_active")
  displayOrder Int        @default(0) @map("display_order")
  createdAt    DateTime   @default(now()) @map("created_at")

  school       SchoolInfo @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  grades       SchoolGrade[]

  @@unique([schoolId, iscedLevel])
  @@index([schoolId, isActive])
  @@map("school_educational_levels")
}

// NEW: Custom grades (was JSON in customGrades)
model SchoolGrade {
  id                     String                  @id @default(cuid())
  schoolId               String                  @map("school_id")
  educationalLevelId     String?                 @map("educational_level_id")
  gradeCode              String                  @map("grade_code") // e.g., "K", "1st", "2nd"
  gradeName              String                  @map("grade_name") // e.g., "Kinder", "Primero B谩sico"
  description            String?
  ageRange               String?                 @map("age_range") // e.g., "5-6 a帽os"
  capacity               Int?                    // Max students
  isActive               Boolean                 @default(true) @map("is_active")
  displayOrder           Int                     @default(0) @map("display_order")
  createdAt              DateTime                @default(now()) @map("created_at")

  school                 SchoolInfo              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  educationalLevel       SchoolEducationalLevel? @relation(fields: [educationalLevelId], references: [id], onDelete: SetNull)
  subjects               GradeSubjectAssignment[]
  students               Student[]

  @@unique([schoolId, gradeCode])
  @@index([schoolId, isActive])
  @@index([educationalLevelId])
  @@map("school_grades")
}

// NEW: Custom subjects (was JSON in customSubjects)
model SchoolSubject {
  id           String    @id @default(cuid())
  schoolId     String    @map("school_id")
  subjectCode  String    @map("subject_code") // e.g., "MATH", "LANG", "SCI"
  subjectName  String    @map("subject_name") // e.g., "Matem谩ticas", "Lenguaje"
  description  String?
  category     String?   // e.g., "Core", "Elective", "Extra"
  color        String?   // For UI display
  isActive     Boolean   @default(true) @map("is_active")
  displayOrder Int       @default(0) @map("display_order")
  createdAt    DateTime  @default(now()) @map("created_at")

  school       SchoolInfo                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  gradeAssignments GradeSubjectAssignment[]
  planningDocuments PlanningDocument[]
  progressReports StudentProgressReport[]

  @@unique([schoolId, subjectCode])
  @@index([schoolId, isActive])
  @@map("school_subjects")
}

// NEW: Grade-Subject relationships
model GradeSubjectAssignment {
  id              String       @id @default(cuid())
  gradeId         String       @map("grade_id")
  subjectId       String       @map("subject_id")
  hoursPerWeek    Int?         @map("hours_per_week")
  isRequired      Boolean      @default(true) @map("is_required")
  createdAt       DateTime     @default(now()) @map("created_at")

  grade           SchoolGrade  @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  subject         SchoolSubject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([gradeId, subjectId])
  @@map("grade_subject_assignments")
}

// NEW: Educational configuration (was JSON in educationalConfig)
model SchoolConfiguration {
  id           String     @id @default(cuid())
  schoolId     String     @map("school_id")
  configKey    String     @map("config_key") // e.g., "grading_system", "academic_year"
  configValue  String     @map("config_value") // JSON string for complex values
  description  String?
  category     String?    // e.g., "academic", "administrative", "system"
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  school       SchoolInfo @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, configKey])
  @@index([schoolId, category])
  @@map("school_configurations")
}

// ===== UPDATED MODELS WITH PROPER FOREIGN KEYS =====

// Updated PlanningDocument to use proper subject reference
model PlanningDocument {
  id          String         @id @default(cuid())
  title       String
  content     String
  subjectId   String?        @map("subject_id") // FK to SchoolSubject
  gradeId     String?        @map("grade_id")   // FK to SchoolGrade
  authorId    String         @map("author_id")
  attachments Json?          // Keep for file URLs until proper file management
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  author      User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  subject     SchoolSubject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  grade       SchoolGrade?   @relation(fields: [gradeId], references: [id], onDelete: SetNull)

  @@index([authorId])
  @@index([subjectId])
  @@index([gradeId])
  @@index([updatedAt])
  @@map("planning_documents")
}

// Updated Student model to use proper grade reference
model Student {
  id               String     @id @default(cuid())
  firstName        String     @map("first_name")
  lastName         String     @map("last_name")
  birthDate        DateTime   @map("birth_date")
  gradeId          String     @map("grade_id") // FK to SchoolGrade
  enrollmentDate   DateTime   @map("enrollment_date")
  medicalInfo      String?    @map("medical_info")
  emergencyContact String?    @map("emergency_contact")
  allergies        String?
  specialNeeds     String?    @map("special_needs")
  attendanceRate   Float?     @map("attendance_rate") @default(0)
  academicProgress Float?     @map("academic_progress") @default(0)
  teacherId        String     @map("teacher_id")
  parentId         String     @map("parent_id")
  isActive         Boolean    @default(true) @map("is_active")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  teacher          User       @relation("StudentTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  parent           User       @relation("StudentParent", fields: [parentId], references: [id], onDelete: Cascade)
  grade            SchoolGrade @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  meetings         Meeting[]  @relation("StudentMeetings")
  progressReports  StudentProgressReport[]

  @@index([teacherId])
  @@index([parentId])
  @@index([gradeId])
  @@map("students")
}

// Updated StudentProgressReport to use proper subject reference  
model StudentProgressReport {
  id               String         @id @default(cuid())
  studentId        String         @map("student_id")
  reportDate       DateTime       @map("report_date")
  subjectId        String?        @map("subject_id") // FK to SchoolSubject
  gradeValue       String         @map("grade_value") // The actual grade/score
  comments         String
  score            Float?
  teacherId        String         @map("teacher_id")
  createdAt        DateTime       @default(now()) @map("created_at")

  student          Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher          User           @relation("ProgressReportTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  subject          SchoolSubject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)

  @@index([studentId])
  @@index([teacherId])
  @@index([subjectId])
  @@index([reportDate])
  @@map("student_progress_reports")
}

// ===== NEW ERROR LOGGING SYSTEM =====
// Replaces in-memory error storage

model ErrorLog {
  id          String      @id @default(cuid())
  errorType   String      @map("error_type") // 'javascript', 'network', 'validation', etc.
  message     String
  stack       String?
  url         String?
  userAgent   String?     @map("user_agent")
  userId      String?     @map("user_id")
  severity    ErrorSeverity @default(MEDIUM)
  context     Json?       // Additional context data
  resolved    Boolean     @default(false)
  resolvedBy  String?     @map("resolved_by")
  resolvedAt  DateTime?   @map("resolved_at")
  createdAt   DateTime    @default(now()) @map("created_at")
  
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  resolver    User?       @relation("ErrorLogResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([severity, resolved])
  @@index([userId])
  @@index([createdAt])
  @@index([errorType])
  @@map("error_logs")
}

// Update User model to include error log relations
// (Add this to the User model relations section)
/*
  errorLogs     ErrorLog[] 
  resolvedErrors ErrorLog[] @relation("ErrorLogResolver")
*/

// ===== REMAINING MODELS (UNCHANGED) =====
// Include all other existing models here...
// TeamMember, Meeting, CalendarEvent, etc.

// ===== ENUMS =====

enum UserRole {
  MASTER
  ADMIN
  PROFESOR
  PARENT
  PUBLIC
}

enum UserStatus {
  PENDING
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum EducationalInstitutionType {
  PRESCHOOL      // Educaci贸n Parvularia  
  BASIC_SCHOOL   // Educaci贸n B谩sica
  HIGH_SCHOOL    // Educaci贸n Media
  COLLEGE        // Educaci贸n Superior

  @@map("EducationalInstitutionType")
}

enum ISCEDLevel {
  LEVEL_0  // Early childhood education
  LEVEL_1  // Primary education
  LEVEL_2  // Lower secondary education
  LEVEL_3  // Upper secondary education
  LEVEL_4  // Post-secondary non-tertiary education
  LEVEL_5  // Short-cycle tertiary education
  LEVEL_6  // Bachelor's or equivalent level
  LEVEL_7  // Master's or equivalent level
  LEVEL_8  // Doctoral or equivalent level

  @@map("ISCEDLevel")
}

enum ErrorSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ... (include all other existing enums and models)

// Note: This is a reference schema showing the normalized structure.
// Implement gradually through migrations to avoid breaking changes.