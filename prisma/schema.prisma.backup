generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model User {
  id                String                  @id @default(cuid())
  name              String?
  email             String                  @unique
  emailVerified     DateTime?               @map("email_verified")
  image             String?
  password          String?
  phone             String?
  role              UserRole                @default(PROFESOR)
  isActive          Boolean                 @default(true) @map("is_active")
  parentRole        String?                 @map("parent_role")
  status            UserStatus?             @default(ACTIVE)
  provider          String?
  isOAuthUser       Boolean                 @default(false) @map("is_oauth_user")
  createdByAdmin    String?                 @map("created_by_admin")
  createdAt         DateTime                @default(now()) @map("created_at")
  updatedAt         DateTime                @updatedAt @map("updated_at")
  accounts          Account[]
  eventTemplates    CalendarEventTemplate[]
  authoredEvents    CalendarEvent[]         @relation("CalendarEventAuthor")
  meetings          Meeting[]
  uploadedPhotos    Photo[]                 @relation("PhotoUploader")
  planningDocuments PlanningDocument[]
  sessions          Session[]
  uploadedVideos    Video[]                 @relation("VideoUploader")
  votes             VoteResponse[]          @relation("UserVotes")
  attendingEvents   CalendarEvent[]         @relation("CalendarEventAttendees")
  createdVotes      Vote[]                  @relation("VoteCreator")
  activities        Activity[]
  taughtStudents     Student[]                @relation("StudentTeacher")
  parentStudents     Student[]                @relation("StudentParent")
  progressReports    StudentProgressReport[]  @relation("ProgressReportTeacher")
  sentNotifications  Notification[]           @relation("NotificationSender")
  receivedNotifications Notification[]        @relation("NotificationRecipient")


  @@map("users")
}

model PlanningDocument {
  id          String   @id @default(cuid())
  title       String
  content     String
  subject     String
  grade       String
  authorId    String   @map("author_id")
  attachments Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([subject])
  @@index([grade])
  @@index([updatedAt])
  @@map("planning_documents")
}

model SchoolInfo {
  id                     String                      @id @default(cuid())
  name                   String
  mission                String
  vision                 String
  address                String
  phone                  String
  email                  String
  website                String
  logoUrl                String?                     @map("logo_url")
  institutionType        EducationalInstitutionType  @default(PRESCHOOL) @map("institution_type")
  supportedLevels        Json?                       @map("supported_levels") // Array of supported ISCED levels
  customGrades          Json?                       @map("custom_grades") // Custom grade definitions
  customSubjects        Json?                       @map("custom_subjects") // Custom subject areas
  educationalConfig     Json?                       @map("educational_config") // Additional educational settings
  createdAt             DateTime                    @default(now()) @map("created_at")
  updatedAt             DateTime                    @default(now()) @updatedAt @map("updated_at")

  @@map("school_info")
}

model TeamMember {
  id          String   @id @default(cuid())
  name        String
  title       String
  description String
  specialties Json
  imageUrl    String?  @map("image_url")
  order       Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("team_members")
}

model Meeting {
  id               String        @id @default(cuid())
  title            String
  description      String?
  studentName      String        @map("student_name")
  studentGrade     String        @map("student_grade")
  guardianName     String        @map("guardian_name")
  guardianEmail    String        @map("guardian_email")
  guardianPhone    String        @map("guardian_phone")
  scheduledDate    DateTime      @map("scheduled_date")
  scheduledTime    String        @map("scheduled_time")
  duration         Int           @default(30)
  location         String        @default("Sala de Reuniones")
  status           MeetingStatus @default(SCHEDULED)
  type             MeetingType   @default(PARENT_TEACHER)
  assignedTo       String        @map("assigned_to")
  notes            String?
  outcome          String?
  followUpRequired Boolean       @default(false) @map("follow_up_required")
  attachments      Json?
  source           MeetingSource @default(STAFF_CREATED)
  reason           String?
  parentRequested  Boolean       @default(false) @map("parent_requested")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  teacher          User          @relation(fields: [assignedTo], references: [id])
  student          Student?      @relation("StudentMeetings", fields: [studentId], references: [id])
  studentId        String?       @map("student_id")

  @@index([assignedTo])
  @@index([studentId])

  @@index([scheduledDate])
  @@index([status])
  @@index([source])
  @@index([parentRequested])
  @@map("meetings")
}

model MeetingTemplate {
  id          String      @id @default(cuid())
  name        String
  description String?
  duration    Int         @default(30)
  type        MeetingType
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@map("meeting_templates")
}

model CalendarEvent {
  id             String          @id @default(cuid())
  title          String
  description    String?
  startDate      DateTime        @map("start_date")
  endDate        DateTime        @map("end_date")
  category       EventCategory
  priority       EventPriority   @default(MEDIUM)
  level          String          @default("both")
  isRecurring    Boolean         @default(false) @map("is_recurring")
  isAllDay       Boolean         @default(false) @map("is_all_day")
  color          String?
  location       String?
  isActive       Boolean         @default(true) @map("is_active")
  attachments    String?
  metadata       String?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  createdBy      String          @map("created_by")
  updatedBy      String          @map("updated_by")
  version        Int             @default(1)
  author         User            @relation("CalendarEventAuthor", fields: [createdBy], references: [id], onDelete: Cascade)
  recurrenceRule RecurrenceRule?
  attendees      User[]          @relation("CalendarEventAttendees")

  @@index([startDate])
  @@index([endDate])
  @@index([category])
  @@index([priority])
  @@index([isActive])
  @@index([createdBy])
  @@index([startDate, endDate, category, isActive], map: "idx_calendar_events_date_category")
  @@index([createdBy, category, isActive], map: "idx_calendar_events_author_role")
  @@index([isRecurring, startDate], map: "idx_calendar_events_recurrence")
  @@index([priority, startDate, isActive], map: "idx_calendar_events_priority_date")
  @@map("calendar_events")
}

model RecurrenceRule {
  id              String            @id @default(cuid())
  calendarEventId String            @unique @map("calendar_event_id")
  pattern         RecurrencePattern
  interval        Int               @default(1)
  daysOfWeek      String            @default("") @map("days_of_week")
  monthOfYear     Int?              @map("month_of_year")
  weekOfMonth     Int?              @map("week_of_month")
  endDate         DateTime?         @map("end_date")
  occurrences     Int?
  exceptions      String            @default("")
  calendarEvent   CalendarEvent     @relation(fields: [calendarEventId], references: [id], onDelete: Cascade)

  @@map("recurrence_rules")
}

model CalendarEventTemplate {
  id          String        @id @default(cuid())
  name        String
  title       String
  description String?
  category    EventCategory
  level       String        @default("both")
  color       String?
  duration    Int           @default(60)
  isAllDay    Boolean       @default(false) @map("is_all_day")
  recurrence  String?
  createdBy   String        @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  user        User          @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([createdBy])
  @@map("calendar_event_templates")
}

model Photo {
  id          String   @id @default(cuid())
  title       String?
  description String?
  url         String
  uploadedBy  String   @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation("PhotoUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([uploadedBy])
  @@index([createdAt])
  @@map("photos")
}

model Video {
  id          String   @id @default(cuid())
  title       String
  description String?
  url         String
  thumbnail   String?
  category    String?
  tags        Json?
  isPublic    Boolean  @default(false) @map("is_public")
  uploadedBy  String   @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  uploader    User     @relation("VideoUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([uploadedBy])
  @@index([category])
  @@index([isPublic])
  @@map("videos")
}

model VideoCapsule {
  id          String   @id @default("default-capsule")
  title       String
  description String?
  url         String
  isActive    Boolean  @default(false) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("video_capsules")
}

model Vote {
  id          String         @id @default(cuid())
  title       String
  description String?
  category    VoteCategory   @default(GENERAL)
  endDate     DateTime       @map("end_date")
  isActive    Boolean        @default(true) @map("is_active")
  isPublic    Boolean        @default(true) @map("is_public")
  allowMultipleVotes Boolean @default(false) @map("allow_multiple_votes")
  maxVotesPerUser Int?       @map("max_votes_per_user")
  requireAuthentication Boolean @default(true) @map("require_authentication")
  createdBy   String         @map("created_by")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  creator     User           @relation("VoteCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  options     VoteOption[]
  responses   VoteResponse[]

  @@index([createdBy])
  @@index([category])
  @@index([isActive])
  @@index([endDate])
  @@map("votes")
}

model VoteOption {
  id        String         @id @default(cuid())
  text      String
  voteId    String         @map("vote_id")
  createdAt DateTime       @default(now()) @map("created_at")
  vote      Vote           @relation(fields: [voteId], references: [id], onDelete: Cascade)
  responses VoteResponse[]

  @@index([voteId])
  @@map("vote_options")
}

model VoteResponse {
  id        String     @id @default(cuid())
  voteId    String     @map("vote_id")
  optionId  String     @map("option_id")
  userId    String     @map("user_id")
  createdAt DateTime   @default(now()) @map("created_at")
  user      User       @relation("UserVotes", fields: [userId], references: [id], onDelete: Cascade)
  option    VoteOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  vote      Vote       @relation(fields: [voteId], references: [id], onDelete: Cascade)

  @@unique([voteId, userId])
  @@index([voteId])
  @@index([optionId])
  @@index([userId])
  @@map("vote_responses")
}
model Student {
  id               String     @id @default(cuid())
  firstName        String     @map("first_name")
  lastName         String     @map("last_name")
  birthDate        DateTime   @map("birth_date")
  grade            String
  enrollmentDate   DateTime   @map("enrollment_date")
  medicalInfo      String?    @map("medical_info")
  emergencyContact String?    @map("emergency_contact")
  allergies        String?
  specialNeeds     String?    @map("special_needs")
  attendanceRate   Float?     @map("attendance_rate") @default(0)
  academicProgress Float?     @map("academic_progress") @default(0)
  teacherId        String     @map("teacher_id")
  parentId         String     @map("parent_id")
  isActive         Boolean    @default(true) @map("is_active")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  teacher          User       @relation("StudentTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  parent           User       @relation("StudentParent", fields: [parentId], references: [id], onDelete: Cascade)
  meetings         Meeting[]  @relation("StudentMeetings")
  progressReports  StudentProgressReport[]

  @@index([teacherId])
  @@index([parentId])
  @@index([grade])
  @@map("students")
}

model StudentProgressReport {
  id               String     @id @default(cuid())
  studentId        String     @map("student_id")
  reportDate       DateTime   @map("report_date")
  subject          String
  grade            String
  comments         String
  score            Float?
  teacherId        String     @map("teacher_id")
  createdAt        DateTime   @default(now()) @map("created_at")

  student          Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher          User       @relation("ProgressReportTeacher", fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([teacherId])
  @@index([reportDate])
  @@map("student_progress_reports")
}



model Activity {
  id               String     @id @default(cuid())
  title            String
  description      String
  type             ActivityType
  subject          String
  grade            String
  scheduledDate    DateTime   @map("scheduled_date")
  scheduledTime    String     @map("scheduled_time")
  duration         Int        // Duration in minutes
  location         String?
  maxParticipants  Int?       @map("max_participants")
  materials        String?
  objectives       String?
  notes            String?
  teacherId        String     @map("teacher_id")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  teacher          User       @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([scheduledDate])
  @@index([type])
  @@index([subject])
  @@index([grade])
  @@map("activities")
}

enum ActivityType {
  CLASS
  EVENT
  WORKSHOP
  EXCURSION
  MEETING
  OTHER
}

enum UserRole {
  MASTER
  ADMIN
  PROFESOR
  PARENT
  PUBLIC
}

enum UserStatus {
  PENDING
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum EventCategory {
  ACADEMIC
  HOLIDAY
  SPECIAL
  PARENT
  ADMINISTRATIVE
  EXAM
  MEETING
  VACATION
  EVENT
  DEADLINE
  OTHER
}

enum EventPriority {
  LOW
  MEDIUM
  HIGH
}

enum RecurrencePattern {
  NONE
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  CUSTOM
}

enum Day {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum MeetingStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum MeetingType {
  PARENT_TEACHER
  FOLLOW_UP
  EMERGENCY
  IEP_REVIEW
  GRADE_CONFERENCE
}

enum MeetingSource {
  STAFF_CREATED
  PARENT_REQUESTED
}

enum VoteCategory {
  GENERAL
  ACADEMIC
  ADMINISTRATIVE
  SOCIAL
  FINANCIAL
  INFRASTRUCTURE
  CURRICULUM
  EVENTS
  POLICIES
  OTHER
}

model Notification {
  id          String      @id @default(cuid())
  title       String
  message     String
  type        NotificationType
  category    NotificationCategory?
  priority    NotificationPriority @default(MEDIUM)
  read        Boolean     @default(false)
  readAt      DateTime?
  actionUrl   String?
  expiresAt   DateTime?
  senderId    String
  recipientId String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  sender    User @relation("NotificationSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient User @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId])
  @@index([read])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([recipientId, read])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
}

enum NotificationCategory {
  MEETING
  VOTING
  SYSTEM
  ACADEMIC
  ADMINISTRATIVE
  PERSONAL
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
}

enum EducationalInstitutionType {
  PRESCHOOL      // Educación Parvularia  
  BASIC_SCHOOL   // Educación Básica
  HIGH_SCHOOL    // Educación Media
  COLLEGE        // Educación Superior

  @@map("EducationalInstitutionType")
}

enum ISCEDLevel {
  LEVEL_0  // Early childhood education
  LEVEL_1  // Primary education
  LEVEL_2  // Lower secondary education
  LEVEL_3  // Upper secondary education
  LEVEL_4  // Post-secondary non-tertiary education
  LEVEL_5  // Short-cycle tertiary education
  LEVEL_6  // Bachelor's or equivalent level
  LEVEL_7  // Master's or equivalent level
  LEVEL_8  // Doctoral or equivalent level

  @@map("ISCEDLevel")
}
